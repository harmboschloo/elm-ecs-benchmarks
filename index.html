<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <script src="./main.js"></script>
  </head>
  <body>
    <script>
      const getPerformance =
        typeof performance !== "undefined"
          ? typeof performance.memory !== "undefined"
            ? function () {
                return {
                  now: performance.now(),
                  usedHeapSize: performance.memory.usedJSHeapSize,
                  totalHeapSize: performance.memory.totalJSHeapSize,
                };
              }
            : function () {
                return {
                  now: performance.now(),
                  usedHeapSize: 0,
                  totalHeapSize: 0,
                };
              }
          : function () {
              return {
                now: Date.now(),
                usedHeapSize: 0,
                totalHeapSize: 0,
              };
            };

      const app = Elm.Main.init();

      app.ports.runBenchmark.subscribe(function (benchmark) {
        const samples = [];
        for (let index = 0; index < benchmark.updateCount; ++index) {
          samples.push({
            index: index,
            dt: 0,
            usedHeapSize: 0,
            totalHeapSize: 0,
          });
        }

        app.ports.initBenchmark.send(null);

        setTimeout(function () {
          switch (benchmark.updateType) {
            case "LoopUpdate":
              runBenchmarkLoop(benchmark, samples);
              break;
            case "TimerUpdate":
              runBenchmarkTimer(benchmark, samples);
              break;
            case "AnimationFrameUpdate":
              runBenchmarkTimer(benchmark, samples);
              break;
          }
        }, 100);
      });

      function runBenchmarkLoop(benchmark, samples) {
        for (let index = 0; index < benchmark.updateCount; ++index) {
          const start = getPerformance();
          app.ports.updateBenchmark.send(null);
          const end = getPerformance();

          samples[index] = {
            index: index,
            dt: end.now - start.now,
            usedHeapSize: end.usedHeapSize,
            totalHeapSize: end.totalHeapSize,
          };
        }

        app.ports.benchmarkEnded.send({
          benchmark: benchmark,
          samples: samples,
        });
      }

      function runBenchmarkTimer(benchmark, samples) {
        let index = 0;

        const update = function () {
          if (index >= benchmark.updateCount) {
            app.ports.benchmarkEnded.send({
              benchmark: benchmark,
              samples: samples,
            });
            return;
          }

          const start = getPerformance();
          app.ports.updateBenchmark.send(null);
          const end = getPerformance();

          samples[index] = {
            index: index,
            dt: end.now - start.now,
            usedHeapSize: end.usedHeapSize,
            totalHeapSize: end.totalHeapSize,
          };

          ++index;

          switch (benchmark.updateType) {
            case "TimerUpdate":
              setTimeout(update);
              break;
            case "AnimationFrameUpdate":
              requestAnimationFrame(update);
              break;
          }
        };

        update();
      }
    </script>
  </body>
</html>
